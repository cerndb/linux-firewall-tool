<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>bin.iptables_manager &#8212; linux-firewall-tool 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="linux-firewall-tool 1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bin.iptables_manager</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>

<span class="c1"># Copyright (C) 2016, CERN</span>
<span class="c1"># This software is distributed under the terms of the GNU General Public</span>
<span class="c1"># Licence version 3 (GPL Version 3), copied verbatim in the file &quot;LICENSE&quot;.</span>
<span class="c1"># In applying this license, CERN does not waive the privileges and immunities</span>
<span class="c1"># granted to it by virtue of its status as Intergovernmental Organization</span>
<span class="c1"># or submit itself to any jurisdiction.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Author: Athanasios Gkaraliakos</span>
<span class="sd">email: a.gkaraliakos@gmail.com</span>
<span class="sd">email: athanasios.gkaraliakos@cern.ch</span>

<span class="sd">The script is written on python &gt;=2.6</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">from</span> <span class="nn">main_nic_extractor</span> <span class="k">import</span> <span class="n">main_nic_extractor</span>
<span class="kn">from</span> <span class="nn">other_nic_extractor</span> <span class="k">import</span> <span class="n">other_nic_extractor</span>
<span class="kn">from</span> <span class="nn">netgroups_set_extraction</span> <span class="k">import</span> <span class="n">netgroup_set_extractor</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))))</span>
<span class="kn">from</span> <span class="nn">iptables_manager_modules.default_rules</span> <span class="k">import</span> <span class="n">DefaultConfiguration</span>
<span class="kn">from</span> <span class="nn">iptables_manager_modules.rules_builder</span> <span class="k">import</span> <span class="n">FirewallRuleBuilder</span>
<span class="kn">from</span> <span class="nn">iptables_manager_modules.generate_files</span> <span class="k">import</span> <span class="n">IPTablesFileGenerator</span>
<span class="kn">from</span> <span class="nn">iptables_manager_modules.rule_map</span> <span class="k">import</span> <span class="n">RuleVisualMapBuilder</span>


<div class="viewcode-block" id="ReadWriteConfigFiles"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ReadWriteConfigFiles">[docs]</a><span class="k">class</span> <span class="nc">ReadWriteConfigFiles</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the config files using python config parser module. It then creates an object(dict)</span>
<span class="sd">    and adds all the sections of the file as key and its options as value.</span>
<span class="sd">    It contains all the methods to parse extract info from the config files and then build and add the rules to both</span>
<span class="sd">    the &#39;iptables&#39; and &#39;ip6tables&#39; so you configure both IP protocols with the same tool.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># parser = configparser.RawConfigParser()</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

<div class="viewcode-block" id="ReadWriteConfigFiles.read_config_file"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ReadWriteConfigFiles.read_config_file">[docs]</a>    <span class="k">def</span> <span class="nf">read_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads all the files on the file path list and creates a unique object to be returned to the Managed Rules</span>
<span class="sd">        class</span>

<span class="sd">        :param filepath: List of config file paths to read</span>
<span class="sd">        :return: object of config parser to access the configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ParsingError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Could not parse file: &#39;</span> <span class="o">+</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">err</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReadWriteConfigFiles.write_config_file"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ReadWriteConfigFiles.write_config_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to write back the current config from memory to the files. (It is not in use for now)</span>
<span class="sd">        :param file_path: list of the files</span>

<span class="sd">        :return: void</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfgfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cfgfile</span><span class="p">)</span>
        <span class="n">cfgfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ManageRules"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules">[docs]</a><span class="k">class</span> <span class="nc">ManageRules</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main class of this script. It handles the whole process of validating config files then parse them and create</span>
<span class="sd">    the kernel ipsets and rules to be applied.</span>
<span class="sd">    It create a list of all the rules to be applied and at the end runs all the iptables commands both for IPv4/IPv6</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rule_builder</span> <span class="o">=</span> <span class="n">FirewallRuleBuilder</span><span class="p">()</span>

    <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All the allowed option of a section that defines iptables rules.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sect_general_options_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;section_type&#39;</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;default_chain&#39;</span><span class="p">,</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;interface&#39;</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="s1">&#39;ports&#39;</span><span class="p">,</span> <span class="s1">&#39;custom_chain&#39;</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;log-level&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;log-prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;set_directions&#39;</span><span class="p">,</span> <span class="s1">&#39;log-specific-options&#39;</span><span class="p">]</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All the allowed option of a section that defines ipsets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sect_set_option_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;section_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ipset_type&#39;</span><span class="p">,</span> <span class="s1">&#39;set_name&#39;</span><span class="p">,</span> <span class="s1">&#39;netgroup_set_name&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;set_hostnames&#39;</span><span class="p">,</span> <span class="s1">&#39;set_ips_v4&#39;</span><span class="p">,</span> <span class="s1">&#39;set_ips_v6&#39;</span><span class="p">,</span> <span class="s1">&#39;set_net_ranges_v4&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;set_net_ranges_v6&#39;</span><span class="p">,</span> <span class="s1">&#39;netgroup_set_list&#39;</span><span class="p">,</span> <span class="s1">&#39;set_ip_port_ip_v4&#39;</span><span class="p">,</span> <span class="s1">&#39;set_ip_port_ip_v6&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;set_ip_port_net_v4&#39;</span><span class="p">,</span> <span class="s1">&#39;set_ip_port_net_v6&#39;</span><span class="p">,</span> <span class="s1">&#39;list_set_sections&#39;</span><span class="p">]</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All the allowed option of a section that defines Policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">policy_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;section_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">simul</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init method of the class</span>

<span class="sd">        :param parser: Config parser object to access the files configuration</span>
<span class="sd">        :param simul: Bool variable to check if we will print the generated config or run it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span> <span class="o">=</span> <span class="n">simul</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_files</span> <span class="o">=</span> <span class="n">generate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_override</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_override</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1">###########################################################################################################</span>
<div class="viewcode-block" id="ManageRules.config_integrity_check"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.config_integrity_check">[docs]</a>    <span class="k">def</span> <span class="nf">config_integrity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method add all the section loaded from config files to a list for better handling. Its main purpose is to</span>
<span class="sd">        check the &#39;integrity&#39; of the config files in terms of specifying the right things of avoid logical errors.</span>

<span class="sd">        :return: void</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="c1"># print i.encode(&quot;utf-8&quot;)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;section_type&quot;</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;Specify &#39;section_type&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="s1">&#39;section_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp_opt</span> <span class="o">==</span> <span class="s1">&#39;general&#39;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;action&quot;</span><span class="p">):</span>
                        <span class="nb">print</span> <span class="s2">&quot;Specify &#39;action&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;action&quot;</span><span class="p">)))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s2">&quot;Specify &#39;action&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Check for script and replace the name with the one returned from the script</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set&quot;</span><span class="p">):</span>
                        <span class="n">script_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">script_command</span><span class="p">:</span>
                            <span class="n">script_command</span> <span class="o">=</span> <span class="n">script_command</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="n">script_command</span> <span class="o">=</span> <span class="n">script_command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                            <span class="n">replace_set</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">script_command</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">err</span> <span class="ow">or</span> <span class="p">(</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="nb">print</span> <span class="s2">&quot;Error with script defining set name on section: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">replace_set</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="n">replace_set</span> <span class="o">=</span> <span class="n">replace_set</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">replace_set</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="n">replace_set</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Error on section: &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; set section &#39;&quot;</span> <span class="o">+</span> \
                                      <span class="n">replace_set</span> <span class="o">+</span> <span class="s2">&quot;&#39; does exist in the current loaded sections. Please create &quot;</span> \
                                                    <span class="s2">&quot;that section inside the config files&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span> <span class="s2">&quot;Error on section: &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; set section &#39;&quot;</span> <span class="o">+</span> \
                                      <span class="n">replace_set</span> <span class="o">+</span> <span class="s2">&quot;&#39; does exist in the current loaded sections. Please create &quot;</span> \
                                                    <span class="s2">&quot;that section inside the config files&quot;</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;default_chain&quot;</span><span class="p">):</span>
                        <span class="n">df_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;default_chain&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="n">sup_chains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">df_chain</span><span class="p">:</span>
                            <span class="n">df_chain</span> <span class="o">=</span> <span class="n">df_chain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">df_chain</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sup_chains</span><span class="p">:</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Default chain specified &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;&#39; not in supported list &quot;</span><span class="p">,</span> <span class="n">sup_chains</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">df_chain</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sup_chains</span><span class="p">:</span>
                                <span class="nb">print</span> <span class="s2">&quot;Default chain specified &#39;&quot;</span> <span class="o">+</span> <span class="n">df_chain</span> <span class="o">+</span> <span class="s2">&quot;&#39; not in supported list &quot;</span><span class="p">,</span> <span class="n">sup_chains</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;ip_version&quot;</span><span class="p">):</span>
                        <span class="nb">print</span> <span class="s2">&quot;Specify &#39;ip_version&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;protocol&quot;</span><span class="p">):</span>
                        <span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s1">&#39;protocol&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">protocol</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">pl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tcp&#39;</span><span class="p">,</span> <span class="s1">&#39;udp&#39;</span><span class="p">]:</span>
                                <span class="nb">print</span> <span class="s2">&quot;Protocol value &#39;&quot;</span> <span class="o">+</span> <span class="n">pl</span> <span class="o">+</span> <span class="s2">&quot;&#39;for section&#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; not supported&quot;</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;ports&quot;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;ports&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;ports&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set&quot;</span><span class="p">):</span>
                            <span class="n">tmp_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">tmp_ipset_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tmp_set</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;ipset_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="n">tmp_ipset_type</span><span class="p">:</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Cannot have ports declared on the rule if you use a hash:ip,port or &#39;&quot;</span> <span class="o">+</span> \
                                          <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; and section &#39;&quot;</span> <span class="o">+</span> <span class="n">tmp_set</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                                <span class="k">pass</span>

                        <span class="n">ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;ports&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                            <span class="n">ports</span> <span class="o">=</span> <span class="n">ports</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">:</span>
                                        <span class="nb">print</span> <span class="s2">&quot;Port values &#39;&quot;</span> <span class="o">+</span> <span class="n">pr</span> <span class="o">+</span> <span class="s2">&quot;&#39; for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; not valid&quot;</span>
                                        <span class="nb">print</span> <span class="s2">&quot;Linux ports range is from 1 to 65535&quot;</span>
                                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Port values &#39;&quot;</span> <span class="o">+</span> <span class="n">pr</span> <span class="o">+</span> <span class="s2">&quot;&#39; for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; not valid&quot;</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Ports are only integer numbers&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                            <span class="n">ports</span> <span class="o">=</span> <span class="n">ports</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">left_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">right_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">left_val</span> <span class="o">&lt;</span> <span class="n">right_val</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">):</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Port values &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">left_val</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">right_val</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; for section &#39;&quot;</span>\
                                          <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; not valid&quot;</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Linux ports range is from 1 to 65535&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="nb">print</span> <span class="s2">&quot;Port values &#39;&quot;</span> <span class="o">+</span> <span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39; for section &#39;&quot;</span> \
                                      <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; not valid&quot;</span>
                                <span class="nb">print</span> <span class="s2">&quot;Ports are only integer numbers&quot;</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_directions&quot;</span><span class="p">):</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_directions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;action&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s2">&quot;Set parameters cannot be defined for this &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; section&quot;</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set&quot;</span><span class="p">):</span>
                            <span class="n">tmp_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">pr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;dst&#39;</span><span class="p">]:</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Set parameters for &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; are not valid&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">_tp_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tmp_set</span><span class="p">,</span> <span class="s2">&quot;ipset_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_tp_</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Set parameters for &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; are not equal to the ipset_type&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                                <span class="nb">print</span> <span class="s2">&quot;Cannot read ipset_type for section &#39;&quot;</span> <span class="o">+</span> <span class="n">tmp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; section&quot;</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sect_general_options_list</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s2">&quot;option: &#39;&quot;</span> <span class="o">+</span> <span class="n">opt</span> <span class="o">+</span> <span class="s2">&quot;&#39; not in supported list&quot;</span>

                <span class="k">elif</span> <span class="n">tmp_opt</span> <span class="o">==</span> <span class="s1">&#39;ipset&#39;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;ipset_type&quot;</span><span class="p">):</span>
                        <span class="nb">print</span> <span class="s2">&quot;Specify &#39;ipset_type&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">set_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="s1">&#39;ipset_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">set_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:net,port&#39;</span><span class="p">,</span> <span class="s1">&#39;hash:ip,port&#39;</span><span class="p">,</span> <span class="s1">&#39;hash:net&#39;</span><span class="p">,</span> <span class="s1">&#39;hash:ip&#39;</span><span class="p">,</span> <span class="s1">&#39;hash:ip,port,net&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;hash:ip,port,ip&#39;</span><span class="p">,</span> <span class="s1">&#39;list:set&#39;</span><span class="p">]:</span>
                            <span class="nb">print</span> <span class="s2">&quot;Specify &#39;ipset_type&#39; &#39;hash:net,port&#39;, &#39;hash:ip,port&#39;, &#39;hash:net&#39;, &#39;hash:ip&#39;, &quot;</span> \
                                  <span class="s2">&quot;&#39;hash:ip,port,net&#39;, &#39;hash:ip,port,ip&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">set_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:net,port&#39;</span><span class="p">,</span> <span class="s1">&#39;hash:net&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_net_ranges_v4&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_net_ranges_v6&quot;</span><span class="p">))):</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;set_net_ranges_v4&#39; ,&#39;set_net_ranges_v6&#39; option for section &#39;&quot;</span> \
                                          <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                            <span class="k">elif</span> <span class="n">set_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:ip,port&#39;</span><span class="p">,</span> <span class="s1">&#39;hash:ip&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_ips_v4&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_ips_v6&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_hostnames&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;netgroup_set_list&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;netgroup_set_name&quot;</span><span class="p">))):</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;set_ips_v4&#39; ,&#39;set_ips_v6&#39;, &#39;set_hostnames&#39; option for section &#39;&quot;</span> \
                                          <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                            <span class="k">elif</span> <span class="n">set_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:ip,port,ip&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_ip_port_ip_v4&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_ip_port_ip_v6&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_hostnames&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;netgroup_set_list&quot;</span><span class="p">))):</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;set_ip_port_ip_v4&#39; ,&#39;set_ip_port_ip_v6&#39;, &#39;set_hostnames&#39; option &quot;</span> \
                                          <span class="s2">&quot;for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                            <span class="k">elif</span> <span class="n">set_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:ip,port,net&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_ip_port_net_v4&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_ip_port_net_v6&quot;</span><span class="p">))</span> <span class="ow">or</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_hostnames&quot;</span><span class="p">))):</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;set_ip_port_net_v4&#39; ,&#39;set_ip_port_net_v6&#39;, &#39;set_hostnames&#39; option &quot;</span> \
                                          <span class="s2">&quot;for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                            <span class="k">elif</span> <span class="n">set_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;list:set&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;set_name&quot;</span><span class="p">):</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;set_name&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;list_set_sections&quot;</span><span class="p">):</span>
                                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;list_set_sections&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">list_sections</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s1">&#39;list_set_sections&#39;</span><span class="p">)</span>
                                                                 <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">list_sections</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                                            <span class="k">for</span> <span class="n">_sect_</span> <span class="ow">in</span> <span class="n">list_sections</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">_sect_</span><span class="p">):</span>
                                                    <span class="nb">print</span> <span class="s2">&quot;Section &#39;&quot;</span> <span class="o">+</span> <span class="n">_sect_</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not present. Please define &quot;</span> \
                                                                                 <span class="s2">&quot;this section inside one of your &quot;</span> \
                                                                                 <span class="s2">&quot;config files&quot;</span>
                                                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="nb">print</span> <span class="s2">&quot;You have tou provide a list for &#39;list_set_sections&#39; option for &quot;</span> \
                                                  <span class="s2">&quot;section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                    <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                                        <span class="k">pass</span>

                        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sect_set_option_list</span><span class="p">:</span>
                                <span class="nb">print</span> <span class="s2">&quot;option: &#39;&quot;</span> <span class="o">+</span> <span class="n">opt</span> <span class="o">+</span> <span class="s2">&quot;&#39; not in supported list&quot;</span>

                <span class="k">elif</span> <span class="n">tmp_opt</span> <span class="o">==</span> <span class="s1">&#39;policy&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;ip_version&quot;</span><span class="p">):</span>
                        <span class="nb">print</span> <span class="s2">&quot;Specify &#39;ip_version&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ipv4&#39;</span><span class="p">,</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
                            <span class="nb">print</span> <span class="s2">&quot; &#39;ip_version&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s2">&quot; should be one of &quot;</span>\
                                  <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ipv4&#39;</span><span class="p">,</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_opts</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s2">&quot;option: &#39;&quot;</span> <span class="o">+</span> <span class="n">opt</span> <span class="o">+</span> <span class="s2">&quot;&#39; not in supported list&quot;</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">opt</span> <span class="o">!=</span> <span class="s1">&#39;section_type&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">opt</span> <span class="o">!=</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ACCEPT&#39;</span><span class="p">,</span> <span class="s1">&#39;DROP&#39;</span><span class="p">]):</span>
                            <span class="nb">print</span> <span class="s2">&quot;Policy: &#39;&quot;</span> <span class="o">+</span> <span class="n">opt</span> <span class="o">+</span> <span class="s2">&quot;&#39; not in &quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ACCEPT&#39;</span><span class="p">,</span> <span class="s1">&#39;DROP&#39;</span><span class="p">]</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;section_type&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<span class="c1">###########################################################################################################</span>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ManageRules.handle_nic_cards"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.handle_nic_cards">[docs]</a>    <span class="k">def</span> <span class="nf">handle_nic_cards</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to return a list of network interfaces in order for the rules to be applied to all of them</span>
<span class="sd">        It has 3 modes and can add or subtract interfaces from the list depending on which interfaces you want to apply</span>
<span class="sd">        firewall rules on.</span>

<span class="sd">        :param query: list of commands to perform e.g. [&#39;main&#39;,&#39;+en5&#39;, &#39;+en4&#39;] or [&#39;all&#39;, &#39;-en5&#39;, &#39;-en4&#39;]</span>
<span class="sd">        :return: the list of interfaces</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nic</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;main&#39;</span><span class="p">:</span>
                    <span class="n">main_nic</span> <span class="o">=</span> <span class="n">main_nic_extractor</span><span class="p">()</span>
                    <span class="n">nic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_nic</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="n">nic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s1">&#39;The sign + was expected to add &#39;</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="s1">&#39; this nic to the list. Omitting.. &#39;</span>
                <span class="k">elif</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">nic</span> <span class="o">=</span> <span class="n">other_nic_extractor</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">nic</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s1">&#39;The sign - was expected to add &#39;</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="s1">&#39; this nic to the list. Omitting.. &#39;</span>
                <span class="k">elif</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;other&#39;</span><span class="p">:</span>
                    <span class="n">nic</span> <span class="o">=</span> <span class="n">other_nic_extractor</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">nic</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s1">&#39;The sign - was expected to add &#39;</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="s1">&#39; this nic to the list. Omitting.. &#39;</span>
        <span class="k">return</span> <span class="n">nic</span></div>

<span class="c1">###########################################################################################################</span>
<div class="viewcode-block" id="ManageRules.handle_script_runs"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.handle_script_runs">[docs]</a>    <span class="k">def</span> <span class="nf">handle_script_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipset_section</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">ipset_type</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to handle set triplets to be used in ipsets.</span>

<span class="sd">        :param ipset_section:</span>
<span class="sd">        :param hostname:</span>
<span class="sd">        :param ipset_type:</span>
<span class="sd">        :param ip_version:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">return_list_1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">return_list_2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">part_1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">part_2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">part_3</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">ipset_type</span> <span class="o">==</span> <span class="s1">&#39;hash:ip,port,net&#39;</span> <span class="ow">or</span> <span class="n">ipset_type</span> <span class="o">==</span> <span class="s1">&#39;hash:ip,port,ip&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="s2">&quot;script_double:&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span>
                <span class="n">part_1</span><span class="p">,</span> <span class="n">part_2</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;script_double:&quot;</span> <span class="ow">in</span> <span class="n">part_2</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Section &#39;&quot;</span> <span class="o">+</span> <span class="n">ipset_section</span> <span class="o">+</span> <span class="s2">&quot; cannot use a &#39;script_double&#39; on last element of the triplet&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;script:&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;netgroup:&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">):</span>
                <span class="n">part_1</span><span class="p">,</span> <span class="n">part_2</span><span class="p">,</span> <span class="n">part_3</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">ipset_type</span> <span class="o">==</span> <span class="s1">&#39;hash:ip,port&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;script:&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;netgroup:&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">):</span>
                <span class="n">part_1</span><span class="p">,</span> <span class="n">part_2</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;script_double:&quot;</span> <span class="ow">in</span> <span class="n">part_2</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Section &#39;&quot;</span> <span class="o">+</span> <span class="n">ipset_section</span> <span class="o">+</span> <span class="s2">&quot; cannot use a &#39;script_double&#39; on last element of the triplet&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="s2">&quot;script_double:&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span>
                <span class="n">part_1</span> <span class="o">=</span> <span class="n">hostname</span>

        <span class="k">elif</span> <span class="n">ipset_type</span> <span class="o">==</span> <span class="s1">&#39;hash:net,port&#39;</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Section &#39;&quot;</span> <span class="o">+</span> <span class="n">ipset_section</span> <span class="o">+</span> <span class="s2">&quot; cannot use a &#39;script&#39; for set type hash:net,port&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">part_1</span> <span class="o">=</span> <span class="n">hostname</span>

        <span class="k">if</span> <span class="s1">&#39;script:&#39;</span> <span class="ow">in</span> <span class="n">part_1</span><span class="p">:</span>
            <span class="n">command_1</span> <span class="o">=</span> <span class="n">part_1</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">return_list_1</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">command_1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;script_double:&#39;</span> <span class="ow">in</span> <span class="n">part_1</span><span class="p">:</span>
            <span class="n">command_1</span> <span class="o">=</span> <span class="n">part_1</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">return_list_1</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">command_1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;netgroup:&#39;</span> <span class="ow">in</span> <span class="n">part_1</span><span class="p">:</span>
            <span class="n">netgroup</span> <span class="o">=</span> <span class="n">part_1</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
            <span class="n">return_list_1</span> <span class="o">=</span> <span class="n">netgroup_set_extractor</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">netgroup</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># print &quot;NetGroup_1:&quot;, return_list_1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">part_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">part_3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;script:&#39;</span> <span class="ow">in</span> <span class="n">part_2</span><span class="p">:</span>
                <span class="n">command_2</span> <span class="o">=</span> <span class="n">part_2</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">return_list_2</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">command_2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;netgroup:&#39;</span> <span class="ow">in</span> <span class="n">part_2</span><span class="p">:</span>
                <span class="n">netgroup</span> <span class="o">=</span> <span class="n">part_2</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
                <span class="n">return_list_2</span> <span class="o">=</span> <span class="n">netgroup_set_extractor</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">netgroup</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># print &quot;NetGroup_2:&quot;, return_list_2</span>

        <span class="k">if</span> <span class="n">part_3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;script:&#39;</span> <span class="ow">in</span> <span class="n">part_3</span><span class="p">:</span>
                <span class="n">command_3</span> <span class="o">=</span> <span class="n">part_3</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">return_list_2</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">command_3</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;netgroup:&#39;</span> <span class="ow">in</span> <span class="n">part_3</span><span class="p">:</span>
                <span class="n">netgroup</span> <span class="o">=</span> <span class="n">part_3</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
                <span class="n">return_list_2</span> <span class="o">=</span> <span class="n">netgroup_set_extractor</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">netgroup</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># print &quot;NetGroup_3:&quot;, return_list_2</span>

        <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">return_list_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">return_list_1</span> <span class="o">=</span> <span class="n">return_list_1</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                    <span class="n">return_list_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">return_list_1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span>
                <span class="c1"># print &quot;Result list 1:&quot;, return_list_1</span>

            <span class="k">if</span> <span class="n">return_list_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">return_list_2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">return_list_2</span> <span class="o">=</span> <span class="n">return_list_2</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ipset_type</span> <span class="o">!=</span> <span class="s1">&#39;hash:ip,port,net&#39;</span><span class="p">:</span>
                    <span class="n">return_list_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">return_list_2</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                        <span class="n">return_list_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">return_list_2</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span>
                    <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                        <span class="n">return_list_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">return_list_2</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ipset_type</span> <span class="o">==</span> <span class="s1">&#39;hash:ip,port,net&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">part_2</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">[]</span>
                    <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">part_2</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">return_list_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">return_list_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">part_3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_list_2</span><span class="p">)):</span>
                            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">part_2</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">return_list_2</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_list_2</span><span class="p">)):</span>
                            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">return_list_2</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">return_list_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;script_double:&#39;</span> <span class="ow">in</span> <span class="n">part_1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ipset_type</span> <span class="o">!=</span> <span class="s1">&#39;hash:ip,port&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">)):</span>
                            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">part_2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">)):</span>
                            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">elif</span> <span class="s1">&#39;script:&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="n">ipset_type</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">)):</span>
                            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">part_2</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">part_3</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">)):</span>
                            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_list_1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Section &#39;&quot;</span> <span class="o">+</span> <span class="n">ipset_section</span> <span class="o">+</span> <span class="s2">&quot; script run error&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># print &quot;Return list:&quot;, return_list</span>
        <span class="k">return</span> <span class="n">return_list</span></div>

<span class="c1">###########################################################################################################</span>
<div class="viewcode-block" id="ManageRules.handle_ipsets"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.handle_ipsets">[docs]</a>    <span class="k">def</span> <span class="nf">handle_ipsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipset_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="n">update_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to handle the ipsets. It parses ipset sections by extracting the values from the options</span>
<span class="sd">        provided in the files. It is used to create or update(if set exists) an ipset so to be later used by the</span>
<span class="sd">        iptable rules.</span>

<span class="sd">        :param ipset_section:Name of the ipset section to be parsed</span>
<span class="sd">        :param ip_version: IPv4/IPv6</span>
<span class="sd">        :param update_only: Bool variable to tell the method to do an update of the existing set.</span>
<span class="sd">        :return: It returns two values. 1. The exit code of the other script that handles ipsets 2. The actual name of the created ipset to be used by the rule/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ipset_action</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">iptype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">settype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">set_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">netgroup_networks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ips</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ips</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hostnames</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ips</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">netgroup_set_list</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># set_ipver = self.parser.get(ipset_section, &#39;ip_version&#39;).encode(&#39;utf-8&#39;)</span>
        <span class="n">set_ipver</span> <span class="o">=</span> <span class="n">ip_version</span>
        <span class="n">ipset_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;ipset_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">set_name</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">set_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">hostnames</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_hostnames&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">hostnames</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hostnames</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">_hostnames_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hst</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hostnames</span><span class="p">)):</span>
                <span class="c1"># This part is executed when in the hostnames list we provided also scripts(commands) to be ran</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;script:&quot;</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">hst</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;script_double:&quot;</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">hst</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;netgroup:&quot;</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">hst</span><span class="p">]):</span>
                    <span class="n">_hostnames_</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_script_runs</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">hst</span><span class="p">],</span> <span class="n">ipset_type</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">hst</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ipset_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:ip&#39;</span><span class="p">,</span> <span class="s1">&#39;hash:net&#39;</span><span class="p">]):</span>
                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Section &quot;</span> <span class="o">+</span> <span class="n">ipset_section</span> <span class="o">+</span> <span class="s2">&quot; type is &#39;&quot;</span> <span class="o">+</span> \
                          <span class="n">ipset_type</span> <span class="o">+</span> <span class="s2">&quot;&#39; but you provided extra elements. Change ipset_type option&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hst</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hostnames</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;script:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">hst</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;script_double:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">hst</span><span class="p">])</span> \
                        <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;netgroup:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">hst</span><span class="p">]):</span>
                    <span class="n">_hostnames_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hostnames</span><span class="p">[</span><span class="n">hst</span><span class="p">])</span>

            <span class="k">del</span> <span class="n">hostnames</span><span class="p">[:]</span>
            <span class="n">hostnames</span> <span class="o">=</span> <span class="n">_hostnames_</span>
            <span class="c1"># print &quot;Hostnames: &quot;, hostnames</span>

        <span class="c1"># This part executes the script command if provided instead of hostname list</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">hostnames</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">hostnames</span> <span class="o">=</span> <span class="n">hostnames</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">hostnames</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">hostnames</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hostnames</span> <span class="o">=</span> <span class="n">hostnames</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="n">hostnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hostnames</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span>
                <span class="nb">print</span> <span class="n">hostnames</span>
                <span class="k">for</span> <span class="n">hst</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">hst</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ipset_type</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">):</span>
                        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Section &#39;&quot;</span> <span class="o">+</span> <span class="n">ipset_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; type is &#39;custom&#39; but you provided ports also. &quot;</span> \
                                                                 <span class="s2">&quot; type should include port &quot;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">err</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ipset_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:ip&#39;</span><span class="p">,</span> <span class="s1">&#39;hash:ip,port&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">netgroup_networks</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;netgroup_set_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                <span class="n">netgroup_networks</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">netgroup_networks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                        <span class="n">ips</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_ips_v4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                        <span class="n">ips</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_ips_v6&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># if type(ips) is list:</span>
                <span class="c1">#     # print ips</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="n">ips</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">ips</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ips</span> <span class="o">=</span> <span class="n">ips</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                        <span class="n">ips</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ips</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span>
                        <span class="nb">print</span> <span class="n">ips</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;The error is: &quot;</span><span class="p">,</span> <span class="n">err</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># if ipset_type == &#39;hash:ip&#39;:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">netgroup_set_list</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;netgroup_set_list&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                    <span class="n">netgroup_set_list</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">netgroup_set_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">netgroup_set_list</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Option netgroup_set_list for &#39;&quot;</span> <span class="o">+</span> <span class="n">ipset_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; section should be a list. &quot;</span> \
                                                                                <span class="s2">&quot;Set it correctly&quot;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">ipset_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:net&#39;</span><span class="p">,</span> <span class="s1">&#39;hash:net,port&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_net_ranges_v4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_net_ranges_v6&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ips</span><span class="p">)):</span>
                            <span class="n">ips</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ips</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c1"># print ips</span>
                <span class="n">ips</span> <span class="o">=</span> <span class="n">ips</span>
            <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                <span class="n">ips</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">ips</span> <span class="o">=</span> <span class="n">ips</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="n">ips</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ips</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span>
                    <span class="nb">print</span> <span class="n">ips</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;The error is: &quot;</span><span class="p">,</span> <span class="n">err</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">ipset_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:ip,port,ip&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">netgroup_set_list</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;netgroup_set_list&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                <span class="n">netgroup_set_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">netgroup_set_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">netgroup_set_list</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Option netgroup_set_list for &#39;&quot;</span> <span class="o">+</span> <span class="n">ipset_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; section should be a list. &quot;</span> \
                                                                            <span class="s2">&quot;Set it correctly&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_ip_port_ip_v4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_ip_port_ip_v6&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ips</span><span class="p">)):</span>
                            <span class="n">ips</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ips</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="c1"># print ips</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="n">ips</span>
            <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                <span class="n">ips</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">ipset_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash:ip,port,net&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_ip_port_net_v4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_section</span><span class="p">,</span> <span class="s1">&#39;set_ip_port_net_v6&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ips</span><span class="p">)):</span>
                            <span class="n">ips</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ips</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="c1"># print ips</span>
            <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                <span class="n">ips</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">set_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">check_ipset</span><span class="p">(</span><span class="n">set_ipver</span><span class="p">,</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">check_ipset</span><span class="p">(</span><span class="n">set_ipver</span><span class="p">,</span> <span class="n">netgroup_networks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="n">ipset_type</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;direct&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s1">&#39;SetDoNotExist&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">update_only</span><span class="p">:</span>
                <span class="n">ipset_action</span> <span class="o">=</span> <span class="s1">&#39;create&#39;</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_ipset</span><span class="p">(</span><span class="n">ipset_action</span><span class="p">,</span> <span class="n">set_ipver</span><span class="p">,</span> <span class="n">ipset_type</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">set_name</span><span class="p">,</span>
                                                          <span class="n">netgroup_networks</span><span class="p">,</span> <span class="n">hostnames</span><span class="p">,</span> <span class="n">ips</span><span class="p">,</span> <span class="n">netgroup_set_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">generate_files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_override</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_override</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print &quot;Create RESP: &quot;, response</span>
                <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">set_name</span>

        <span class="k">elif</span> <span class="n">response</span> <span class="o">==</span> <span class="s1">&#39;SetExists&#39;</span><span class="p">:</span>
            <span class="n">ipset_action</span> <span class="o">=</span> <span class="s1">&#39;update&#39;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_ipset</span><span class="p">(</span><span class="n">ipset_action</span><span class="p">,</span> <span class="n">set_ipver</span><span class="p">,</span> <span class="n">ipset_type</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">set_name</span><span class="p">,</span>
                                                      <span class="n">netgroup_networks</span><span class="p">,</span> <span class="n">hostnames</span><span class="p">,</span> <span class="n">ips</span><span class="p">,</span> <span class="n">netgroup_set_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">response</span> <span class="o">==</span> <span class="s1">&#39;IpsetCheckERROR&#39;</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">response</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">netgroup_networks</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">set_name</span></div>

<span class="c1">###########################################################################################################</span>
<div class="viewcode-block" id="ManageRules.handle_list_set"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.handle_list_set">[docs]</a>    <span class="k">def</span> <span class="nf">handle_list_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipset_setction</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="n">update_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to create a list:set type of ipset. This includes other already in memory sets.</span>
<span class="sd">        Works by reading the sections that define the other sets, builds them first and then adds them to it.</span>

<span class="sd">        :param ipset_setction: Section of the list set</span>
<span class="sd">        :param ip_version: ip version to build on IPv4 or IPv6</span>
<span class="sd">        :param update_only: flag to update sets only to be passed to handle ipsets method</span>
<span class="sd">        :return: the response and the name of the set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">actual_set_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">set_name</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_setction</span><span class="p">,</span> <span class="s1">&#39;set_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">set_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">list_set_sections</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ipset_setction</span><span class="p">,</span> <span class="s1">&#39;list_set_sections&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">list_set_sections</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;_v4&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v4&#39;</span>
        <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;_v6&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v6&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_files</span><span class="p">:</span>
            <span class="n">response_exist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">check_ipset</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_exist</span> <span class="o">=</span> <span class="s2">&quot;SetDoNotExist&quot;</span>

        <span class="k">if</span> <span class="n">list_set_sections</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">list_set_sections</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sect</span> <span class="ow">in</span> <span class="n">list_set_sections</span><span class="p">:</span>
                    <span class="n">response</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_ipsets</span><span class="p">(</span><span class="n">sect</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="n">update_only</span><span class="p">)</span>
                    <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                        <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v4&#39;</span>
                    <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                        <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v6&#39;</span>
                    <span class="n">actual_set_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">response_exist</span> <span class="o">==</span> <span class="s2">&quot;SetDoNotExist&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_ipset</span><span class="p">(</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;list:set&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">set_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_files</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">actual_set_names</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">response_exist</span> <span class="o">==</span> <span class="s2">&quot;SetExists&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_ipset</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;list:set&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">set_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_override</span><span class="p">,</span>
                                                   <span class="n">actual_set_names</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response_exist</span> <span class="o">==</span> <span class="s2">&quot;SetDoNotExist&quot;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_ipset</span><span class="p">(</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;list:set&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">set_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                          <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_files</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">elif</span> <span class="n">response_exist</span> <span class="o">==</span> <span class="s2">&quot;SetExists&quot;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_ipset</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;list:set&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">set_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                          <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_override</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">set_name</span></div>


<span class="c1">###########################################################################################################</span>
<div class="viewcode-block" id="ManageRules.handle_bidirectional_rules"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.handle_bidirectional_rules">[docs]</a>    <span class="k">def</span> <span class="nf">handle_bidirectional_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">general_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to build rules serving both INPUT and OUTPUT chains.</span>

<span class="sd">        :param general_section: Name of the rule section</span>
<span class="sd">        :param ip_version: IPv4/IPv6</span>
<span class="sd">        :return: A list of iptables and ip6tables commands to be run so the rules are applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rules_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chain_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">jump_chain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">action</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">))</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">general_section</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;interface&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nic</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="n">main_nic_extractor</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">nic</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="n">other_nic_extractor</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">nic</span> <span class="o">==</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="n">other_nic_extractor</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;interface&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_nic_cards</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nic</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Interfaces option not set correctly for section </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1"> Setting to None&#39;</span>
                    <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Interfaces option not set correctly for section </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1"> Setting to None&#39;</span>
            <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="c1"># print protocol</span>
            <span class="c1"># sys.exit(1)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;ports&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                    <span class="n">ports</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span>
                    <span class="n">ports</span> <span class="o">=</span> <span class="n">ports</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="nb">print</span> <span class="s2">&quot;Ports script: &quot;</span><span class="p">,</span> <span class="n">ports</span>
                    <span class="n">pr_tmp</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;Section &quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot; ports script: &quot;</span> <span class="o">+</span> <span class="n">ports</span>
                        <span class="nb">print</span> <span class="n">err</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ports</span> <span class="o">=</span> <span class="n">pr_tmp</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">):</span>
            <span class="n">set_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">set_section</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="s2">&quot;ipset_type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;list:set&quot;</span><span class="p">:</span>
                    <span class="n">response_set</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_ipsets</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response_set</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_list_set</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response_set</span> <span class="o">==</span> <span class="s1">&#39;SETNOTFOUND&#39;</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;SETNOTFOUND&#39;</span>
                    <span class="nb">print</span> <span class="s1">&#39;Section: &#39;</span><span class="p">,</span> <span class="n">general_section</span>
                    <span class="nb">print</span> <span class="s1">&#39;Set: &#39;</span><span class="p">,</span> <span class="n">set_name</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     print &quot;RESPONSE_SET: &quot;, response_set</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Specified ipset section </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">set_section</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> does not exist&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;out&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">):</span>
            <span class="n">jump_chain</span> <span class="o">=</span> <span class="s1">&#39;ACCEPT&#39;</span>
            <span class="n">chain_name</span> <span class="o">=</span> <span class="s1">&#39;INPUT&#39;</span>
            <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NEW,ESTABLISHED&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">response_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                        <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v4&#39;</span>
                    <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                        <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v6&#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="s1">&#39;ipset_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
                        <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;src,dst&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;src&#39;</span><span class="p">]</span>
                    <span class="nb">print</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">response_set</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Usage problem with ipset&quot;</span>
                    <span class="nb">print</span> <span class="n">response_set</span>
                    <span class="nb">print</span> <span class="n">set_name</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ports</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;multiport&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dports&#39;</span><span class="p">,</span> <span class="n">ports</span><span class="p">]</span>
            <span class="c1"># print chain_name, ip_version, nic, protocol, comment, modules, jump_chain</span>
            <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                        <span class="n">protocol</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                    <span class="n">protocol</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">protocol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                            <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                            <span class="n">pl</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span>
                                                                        <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>

            <span class="n">chain_name</span> <span class="o">=</span> <span class="s1">&#39;OUTPUT&#39;</span>
            <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ESTABLISHED&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">response_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="s1">&#39;ipset_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
                        <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dst,dst&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dst&#39;</span>
            <span class="c1"># if ports is not None:</span>
            <span class="c1">#     modules[&#39;multiport&#39;][0] = &#39;sports&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;multiport&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># print chain_name, ip_version, nic, protocol, comment, modules, jump_chain</span>
            <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                        <span class="n">protocol</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                    <span class="n">protocol</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">protocol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                            <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                            <span class="n">pl</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span>
                                                                        <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;out&#39;</span><span class="p">):</span>
            <span class="n">jump_chain</span> <span class="o">=</span> <span class="s1">&#39;ACCEPT&#39;</span>
            <span class="n">chain_name</span> <span class="o">=</span> <span class="s1">&#39;INPUT&#39;</span>
            <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ESTABLISHED&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">response_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                        <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v4&#39;</span>
                    <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                        <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v6&#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="s1">&#39;ipset_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
                        <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;src,dst&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;src&#39;</span><span class="p">]</span>
                    <span class="nb">print</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">response_set</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Usage problem with ipset&quot;</span>
                    <span class="nb">print</span> <span class="n">response_set</span>
                    <span class="nb">print</span> <span class="n">set_name</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># if ports is not None:</span>
            <span class="c1">#     modules[&#39;multiport&#39;] = [&#39;dports&#39;, ports]</span>
            <span class="c1"># print chain_name, ip_version, nic, protocol, comment, modules, jump_chain</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;multiport&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                        <span class="n">protocol</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                    <span class="n">protocol</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">protocol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                            <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                            <span class="n">pl</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span>
                                                                        <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
            <span class="n">chain_name</span> <span class="o">=</span> <span class="s1">&#39;OUTPUT&#39;</span>
            <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NEW,ESTABLISHED&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">response_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="s1">&#39;ipset_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
                        <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dst,dst&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dst&#39;</span>
            <span class="k">if</span> <span class="n">ports</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># modules[&#39;multiport&#39;][0] = &#39;sports&#39;</span>
                <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;multiport&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dports&#39;</span><span class="p">,</span> <span class="n">ports</span><span class="p">]</span>
            <span class="c1"># print chain_name, ip_version, nic, protocol, comment, modules, jump_chain</span>
            <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                        <span class="n">protocol</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                    <span class="n">protocol</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">protocol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                            <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                            <span class="n">pl</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span>
                                                                        <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Specify &#39;action&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; properly&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rules_list</span></div>

<span class="c1">###########################################################################################################</span>

<div class="viewcode-block" id="ManageRules.single_chain_rule"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.single_chain_rule">[docs]</a>    <span class="k">def</span> <span class="nf">single_chain_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">general_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to create signle rules on one of/both the default chains. Tries to extract the values of the</span>
<span class="sd">        possible options in order to build the rule</span>

<span class="sd">        :param general_section: Name of the section</span>
<span class="sd">        :param ip_version: IPv4/IPv6</span>
<span class="sd">        :return: a list of rule/rules (2 rules if tcp and udp are defined)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rules_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">jump_chain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">action</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">))</span>
        <span class="c1"># comment = self.parser.get(general_section, &#39;md5&#39;).encode(&#39;utf-8&#39;)</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">general_section</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Section name:&quot;</span><span class="p">,</span> <span class="n">general_section</span>
            <span class="n">nic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;interface&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nic</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="n">main_nic_extractor</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">nic</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="n">other_nic_extractor</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">nic</span> <span class="o">==</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="n">other_nic_extractor</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;interface&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="c1"># nic = nic.split(&#39;,&#39;)</span>
                <span class="nb">print</span> <span class="s2">&quot;nic: &quot;</span><span class="p">,</span> <span class="n">nic</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_nic_cards</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nic</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Interfaces option not set correctly for section </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1"> Setting to None&#39;</span>
                    <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Interfaces option not set correctly for section </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1"> Setting to None&#39;</span>
            <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="c1"># print protocol</span>
            <span class="c1"># sys.exit(1)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;ports&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                    <span class="n">ports</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span>
                    <span class="n">ports</span> <span class="o">=</span> <span class="n">ports</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="nb">print</span> <span class="s2">&quot;Ports script: &quot;</span><span class="p">,</span> <span class="n">ports</span>
                    <span class="n">pr_tmp</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;Section &quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot; ports script: &quot;</span> <span class="o">+</span> <span class="n">ports</span>
                        <span class="nb">print</span> <span class="n">err</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ports</span> <span class="o">=</span> <span class="n">pr_tmp</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">):</span>
            <span class="n">set_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">set_section</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="s2">&quot;ipset_type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;list:set&quot;</span><span class="p">:</span>
                    <span class="n">response_set</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_ipsets</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response_set</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_list_set</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response_set</span> <span class="o">==</span> <span class="s1">&#39;SETNOTFOUND&#39;</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;SETNOTFOUND&#39;</span>
                    <span class="nb">print</span> <span class="s1">&#39;Section: &#39;</span><span class="p">,</span> <span class="n">general_section</span>
                    <span class="nb">print</span> <span class="s1">&#39;Set: &#39;</span><span class="p">,</span> <span class="n">set_name</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     print &quot;RESPONSE_SET: &quot;, response_set</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Specified ipset section </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">set_section</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> does not exist&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;accept&#39;</span><span class="p">:</span>
            <span class="n">jump_chain</span> <span class="o">=</span> <span class="s1">&#39;ACCEPT&#39;</span>
        <span class="k">elif</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span>
            <span class="n">jump_chain</span> <span class="o">=</span> <span class="s1">&#39;DROP&#39;</span>
        <span class="c1"># chain_name = &#39;INPUT&#39;</span>

        <span class="n">default_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s2">&quot;default_chain&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">default_chain</span> <span class="o">=</span> <span class="n">default_chain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="c1"># modules[&#39;state&#39;] = &#39;NEW,ESTABLISHED&#39;</span>

        <span class="k">for</span> <span class="n">chain_name</span> <span class="ow">in</span> <span class="n">default_chain</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">response_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="c1"># if self.parser.get(set_section, &#39;ipset_type&#39;).encode(&#39;utf-8&#39;) != &quot;list:set&quot;:</span>
                    <span class="k">if</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv4&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;_v4&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v4&#39;</span>
                    <span class="k">elif</span> <span class="n">ip_version</span> <span class="o">==</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;_v6&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_v6&#39;</span>
                    <span class="k">if</span> <span class="n">chain_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set_directions&#39;</span><span class="p">):</span>
                            <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set_directions&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="s1">&#39;ipset_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
                                <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;src,dst&#39;</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;src&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set_directions&#39;</span><span class="p">):</span>
                            <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;set_directions&#39;</span><span class="p">)</span>
                                              <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_section</span><span class="p">,</span> <span class="s1">&#39;ipset_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
                                <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;dst,dst&#39;</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">set_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;dst&#39;</span><span class="p">]</span>
                    <span class="c1"># print set_name[0]</span>

                <span class="k">elif</span> <span class="n">response_set</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Usage problem with ipset&quot;</span>
                    <span class="nb">print</span> <span class="n">response_set</span>
                    <span class="nb">print</span> <span class="n">set_name</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ports</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;multiport&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dports&#39;</span><span class="p">,</span> <span class="n">ports</span><span class="p">]</span>
            <span class="c1"># print chain_name, ip_version, nic, protocol, comment, modules, jump_chain</span>
            <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span>
                                                                        <span class="n">comment</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span>
                                                                    <span class="n">protocol</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">protocol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">_nic_</span> <span class="ow">in</span> <span class="n">nic</span><span class="p">:</span>
                            <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span>
                                                                            <span class="n">comment</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">_nic_</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span>
                                                                        <span class="n">comment</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">rules_list</span></div>

<span class="c1">###########################################################################################################</span>

<div class="viewcode-block" id="ManageRules.log_with_custom_chain"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.log_with_custom_chain">[docs]</a>    <span class="k">def</span> <span class="nf">log_with_custom_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">general_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to create rules that jump to the LOG chain. It is mainly used by defining a custom chain to</span>
<span class="sd">        jump after INPUT or OUTPUT chain.</span>

<span class="sd">        :param general_section: Name of the section</span>
<span class="sd">        :param ip_version: IPv4/IPv6</span>
<span class="sd">        :return: A list of rule/rules to create the user defined chain and the rules for the default chains that jum to the user defined chain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print &quot;INSIDE LOG DROP&quot;</span>

        <span class="n">rules_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">default_chain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">jump_chain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Try top read all the supported options in order to build the rule</span>
        <span class="n">action</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">))</span>
        <span class="c1"># comment = self.parser.get(general_section, &#39;md5&#39;).encode(&#39;utf-8&#39;)</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">general_section</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">nic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;interface&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nic</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">:</span>
                <span class="n">nic</span> <span class="o">=</span> <span class="n">main_nic_extractor</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">nic</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]:</span>
                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Interface for section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; cannot be all or other &quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;ports&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># try:</span>
        <span class="c1">#     length = self.parser.get(general_section, &#39;length&#39;).encode(&#39;utf-8&#39;)</span>
        <span class="c1"># except configparser.NoOptionError:</span>
        <span class="c1">#     length = None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;log-prefix&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">log_prefix</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">log_prefix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;log-level&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">log_level</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_specific_options</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;log-specific-options&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">log_specific_options</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">default_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s2">&quot;default_chain&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">default_chain</span> <span class="o">=</span> <span class="n">default_chain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_specific_options</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">log_specific_options</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;log-tcp-sequence&#39;</span> <span class="ow">in</span> <span class="n">log_specific_options</span><span class="p">:</span>
                <span class="n">log_tcp_sequence</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_tcp_sequence</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="s1">&#39;log-tcp-options&#39;</span> <span class="ow">in</span> <span class="n">log_specific_options</span><span class="p">:</span>
                <span class="n">log_tcp_options</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_tcp_options</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;log-ip-options&#39;</span><span class="p">):</span>
                <span class="n">log_ip_options</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_ip_options</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_tcp_sequence</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">log_tcp_options</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">log_ip_options</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">custom_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;custom_chain&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">ext_c</span><span class="p">,</span> <span class="n">_cmd_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_custom_chain</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">custom_chain</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ext_c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">custom_chain</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="nb">print</span> <span class="s2">&quot;Error with chain: &quot;</span><span class="p">,</span> <span class="n">custom_chain</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_cmd_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_cmd_</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Please specify custom chain for the section: &quot;</span><span class="p">,</span> <span class="n">general_section</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chain_name</span> <span class="ow">in</span> <span class="n">default_chain</span><span class="p">:</span>
            <span class="c1"># Jump first to the custom chain</span>
            <span class="k">if</span> <span class="n">custom_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">jump_chain</span> <span class="o">=</span> <span class="n">custom_chain</span>
                <span class="c1"># chain_name = &#39;INPUT&#39;</span>
            <span class="c1"># if length is not None:</span>
            <span class="c1">#     modules[&#39;length&#39;] = length</span>

            <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">protocol</span><span class="p">:</span>
                    <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>

        <span class="n">jump_chain</span> <span class="o">=</span> <span class="s1">&#39;LOG&#39;</span>
        <span class="k">if</span> <span class="n">custom_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chain_name</span> <span class="o">=</span> <span class="n">custom_chain</span>
        <span class="c1"># else:</span>
        <span class="c1">#     chain_name = &#39;INPUT&#39;</span>

        <span class="c1"># modules.pop(&#39;length&#39;)</span>

        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">modules</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>

        <span class="n">jump_chain_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">log_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jump_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;log-prefix&#39;</span><span class="p">)</span>
            <span class="n">jump_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jump_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;log-level&#39;</span><span class="p">)</span>
            <span class="n">jump_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_tcp_sequence</span><span class="p">:</span>
            <span class="n">jump_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;log-tcp-sequence&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_tcp_options</span><span class="p">:</span>
            <span class="n">jump_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;log-tcp-options&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_ip_options</span><span class="p">:</span>
            <span class="n">jump_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;log-ip-options&#39;</span><span class="p">)</span>

        <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">jump_chain_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="p">[]:</span>
            <span class="c1"># Insert LOG chain at element 0 of the list in order to create the rule</span>
            <span class="n">jump_chain_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">)</span>
            <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain_list</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain_list</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span>
            <span class="n">jump_chain</span> <span class="o">=</span> <span class="s1">&#39;DROP&#39;</span>
        <span class="k">elif</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;accept&#39;</span><span class="p">:</span>
            <span class="n">jump_chain</span> <span class="o">=</span> <span class="s1">&#39;ACCEPT&#39;</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">custom_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chain_name</span> <span class="o">=</span> <span class="n">custom_chain</span>
        <span class="c1"># else:</span>
        <span class="c1">#     chain_name = &#39;INPUT&#39;</span>

        <span class="n">rules_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">manage_rule</span><span class="p">(</span><span class="n">ip_version</span><span class="p">,</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">jump_chain</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">modules</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">rules_list</span></div>

<span class="c1">###########################################################################################################</span>

<div class="viewcode-block" id="ManageRules.rules_logic_parse"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.rules_logic_parse">[docs]</a>    <span class="k">def</span> <span class="nf">rules_logic_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">general_section</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to decide which rule building method will be called for each section on the config</span>
<span class="sd">        files using the &#39;action&#39; option list.</span>

<span class="sd">        :param general_section: The name iof the section</span>
<span class="sd">        :return: A list of rule/rules depending on the action.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rules_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ip_version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">chain_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">jump_chain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ipv4&#39;</span><span class="p">,</span> <span class="s1">&#39;ipv6&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="nb">print</span> <span class="s2">&quot;Specify &#39;ip_version&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; between ipv4 or ipv6 or both&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># This part is for iptables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ipv4&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="n">ip_version</span> <span class="o">=</span> <span class="s1">&#39;ipv4&#39;</span>
            <span class="n">action</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;accept&#39;</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">((</span><span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">])</span> <span class="ow">and</span>
                                                          <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_bidirectional_rules</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;action&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; properly&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span> <span class="ow">or</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;accept&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;default_chain&#39;</span><span class="p">):</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_with_custom_chain</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;You need to define the &#39;default_chain&#39; option for the section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;action&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; properly&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;accept&#39;</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;default_chain&#39;</span><span class="p">):</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">single_chain_rule</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;You need to define the &#39;default_chain&#39; option for the section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;action&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; properly&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Specify &#39;action&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; properly&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># This part is for ip6tables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ipv6&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="n">ip_version</span> <span class="o">=</span> <span class="s1">&#39;ipv6&#39;</span>
            <span class="n">action</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;accept&#39;</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">((</span><span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">])</span> <span class="ow">and</span>
                                                          <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_bidirectional_rules</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span> <span class="ow">or</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;accept&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;default_chain&#39;</span><span class="p">):</span>
                        <span class="n">rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_with_custom_chain</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;You need to define the &#39;default_chain&#39; option for the section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Specify &#39;action&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; properly&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="s1">&#39;default_chain&#39;</span><span class="p">):</span>
                    <span class="n">rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">single_chain_rule</span><span class="p">(</span><span class="n">general_section</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;You need to define the &#39;default_chain&#39; option for the section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Specify &#39;action&#39; option for section &#39;&quot;</span> <span class="o">+</span> <span class="n">general_section</span> <span class="o">+</span> <span class="s2">&quot;&#39; properly&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rules_list</span></div>

<span class="c1">###########################################################################################################</span>

<div class="viewcode-block" id="ManageRules.ipsets_update"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.ipsets_update">[docs]</a>    <span class="k">def</span> <span class="nf">ipsets_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_list</span><span class="p">,</span> <span class="n">exclude_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to update existing kernel ipsets. It checks for rules that sections and on those that have an ipset</span>
<span class="sd">        defined calls the --&gt; handle_ipsets() method to update the sets.</span>

<span class="sd">        :return: void</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">update_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">exclude_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s1">&#39;Both --update_list and --exclude_list arguments have been defined. Please use only one of &#39;</span> \
                  <span class="s1">&#39;the two.&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">update_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">update_list</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s1">&#39;Please provide a list for the update_list argument&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">exclude_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exclude_list</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s1">&#39;Please provide a list for the exclude_list argument&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">general_sections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sect</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">sect</span><span class="p">],</span> <span class="s1">&#39;section_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;general&#39;</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">sect</span><span class="p">],</span> <span class="s1">&#39;set&#39;</span><span class="p">):</span>
                    <span class="n">_set_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">sect</span><span class="p">],</span> <span class="s1">&#39;set&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">update_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_set_</span> <span class="ow">in</span> <span class="n">update_list</span><span class="p">):</span>
                        <span class="n">general_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">sect</span><span class="p">])</span>

                    <span class="k">elif</span> <span class="p">(</span><span class="n">exclude_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_set_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_list</span><span class="p">):</span>
                        <span class="n">general_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">sect</span><span class="p">])</span>

                    <span class="k">elif</span> <span class="p">(</span><span class="n">update_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">exclude_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">general_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">sect</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">general_sections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sect</span> <span class="ow">in</span> <span class="n">general_sections</span><span class="p">:</span>
                <span class="c1"># if self.parser.has_option(sect, &quot;set&quot;):</span>
                <span class="n">set_sect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sect</span><span class="p">,</span> <span class="s2">&quot;set&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sect</span><span class="p">,</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ipv4&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
                    <span class="n">ip_version</span> <span class="o">=</span> <span class="s1">&#39;ipv4&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_sect</span><span class="p">,</span> <span class="s2">&quot;ipset_type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;list:set&quot;</span><span class="p">:</span>
                        <span class="n">responce</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_ipsets</span><span class="p">(</span><span class="n">set_sect</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">responce</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_list_set</span><span class="p">(</span><span class="n">set_sect</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="n">responce</span><span class="p">,</span> <span class="n">set_name</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sect</span><span class="p">,</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ipv6&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
                    <span class="n">ip_version</span> <span class="o">=</span> <span class="s1">&#39;ipv6&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">set_sect</span><span class="p">,</span> <span class="s2">&quot;ipset_type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;list:set&quot;</span><span class="p">:</span>
                        <span class="n">responce</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_ipsets</span><span class="p">(</span><span class="n">set_sect</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">responce</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_list_set</span><span class="p">(</span><span class="n">set_sect</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="n">responce</span><span class="p">,</span> <span class="n">set_name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">save_ipset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">)</span></div>

<span class="c1">###########################################################################################################</span>

<div class="viewcode-block" id="ManageRules.iptables_policy"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.iptables_policy">[docs]</a>    <span class="k">def</span> <span class="nf">iptables_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to create the rules that set the policy of the default chains.</span>

<span class="sd">        :param policy: Name of the section that contains the policy</span>
<span class="sd">        :return: A list of rule/rules depending on the action.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ip_ver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="s1">&#39;ip_version&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ip_ver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ipv4&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">iptables_command</span> <span class="o">=</span> <span class="n">FirewallRuleBuilder</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">)</span>
                    <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iptables_command</span><span class="p">,</span> <span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">pol</span><span class="p">])</span>
                <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="n">ip_ver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ipv6&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">ip6tables_command</span> <span class="o">=</span> <span class="n">FirewallRuleBuilder</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">)</span>
                    <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ip6tables_command</span><span class="p">,</span> <span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">pol</span><span class="p">])</span>
                <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="n">rules</span></div>

<span class="c1">###########################################################################################################</span>

<div class="viewcode-block" id="ManageRules.parse_file"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.parse_file">[docs]</a>    <span class="k">def</span> <span class="nf">parse_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to distinguish if a section is rule or policy and</span>

<span class="sd">        :return: returns the final rules list - actual list of commands</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">general_sections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">secti</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">secti</span><span class="p">],</span> <span class="s1">&#39;section_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;policy&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">secti</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;More than one policy sections found, please leave only one&#39;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sect</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">sect</span><span class="p">],</span> <span class="s1">&#39;section_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;general&#39;</span><span class="p">:</span>
                <span class="n">general_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">sect</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">general_sections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sect</span> <span class="ow">in</span> <span class="n">general_sections</span><span class="p">:</span>
                <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_logic_parse</span><span class="p">(</span><span class="n">sect</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iptables_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">rules</span></div>

<span class="c1">###########################################################################################################</span>

<div class="viewcode-block" id="ManageRules.apply_firewall_rules"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.ManageRules.apply_firewall_rules">[docs]</a>    <span class="k">def</span> <span class="nf">apply_firewall_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to apply the firewall rules. It receives a list of iptables commands and runs all the</span>
<span class="sd">        commands one after the other.</span>
<span class="sd">        The iptables rules come with &#39;-C&#39; param in order to check if the exist. If not the &#39;-C&#39; becomes &#39;-A&#39; so we can</span>
<span class="sd">        add them to the configuration.</span>

<span class="sd">        :param command_list: The final commands list to run.</span>
<span class="sd">        :return: void</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">save_ipset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">)</span>

        <span class="n">final</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">command_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="s1">&#39;iptables&#39;</span> <span class="ow">in</span> <span class="n">command_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="s1">&#39;ip6tables&#39;</span> <span class="ow">in</span> <span class="n">command_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="nb">print</span> <span class="s1">&#39;&#39;</span>
            <span class="nb">print</span> <span class="s2">&quot;######### USER DEFINED FIREWALL RULES #########&quot;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">final</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">:</span>
                    <span class="c1"># Replace [comment] with &quot;comment&quot; so the comments on the rules are inserted properly</span>
                    <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-C&#39;</span><span class="p">:</span>
                        <span class="n">responce</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Change &#39;-C&#39; (check if rule exists) to &#39;-A&#39; (add the rule) and put it in a rule only list</span>
                        <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-C&#39;</span><span class="p">:</span>
                            <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-A&#39;</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="nb">print</span> <span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>

                        <span class="nb">print</span> <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">responce</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_builder</span><span class="o">.</span><span class="n">sys_process_executor</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Change &#39;-C&#39; (check if rule exists) to &#39;-A&#39; (add the rule) and put it in a rule only list</span>
                        <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-C&#39;</span><span class="p">:</span>
                            <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-A&#39;</span>
                        <span class="nb">print</span> <span class="s2">&quot;Rule already exists&quot;</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="nb">print</span> <span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                        <span class="nb">print</span> <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Replace [comment] with &quot;comment&quot; so the comments on the rules are inserted properly</span>
                    <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="c1"># Change &#39;-C&#39; (check if rule exists) to &#39;-A&#39; (add the rule) and put it in a rule only list</span>
                    <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-C&#39;</span><span class="p">:</span>
                        <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-A&#39;</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="nb">print</span> <span class="n">j</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                    <span class="nb">print</span> <span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="nb">print</span> <span class="s2">&quot;######### USER DEFINED FIREWALL RULES #########&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Comand list empty !!!!!&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s1">&#39;&#39;</span>
        <span class="k">del</span> <span class="n">command_list</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="n">command_list</span>
        <span class="k">del</span> <span class="n">final</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="n">final</span></div></div>


<span class="k">def</span> <span class="nf">print_default_rules</span><span class="p">(</span><span class="n">rule_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">print</span> <span class="s2">&quot;######### DEFAULT FIREWALL RULES #########&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rule_list</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">i</span>
        <span class="nb">print</span> <span class="s2">&quot;######### DEFAULT FIREWALL RULES #########&quot;</span>


<span class="c1">###########################################################################################################</span>
<div class="viewcode-block" id="iptables_manager"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.iptables_manager">[docs]</a><span class="k">def</span> <span class="nf">iptables_manager</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">no_default_config</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drop_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">update_sets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deploy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">generate_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">map_config_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is the actual main function. It is used as &#39;proxy&#39; method so you can either use this script from a</span>
<span class="sd">    another python script or directly from command line. This method is being called with either the &#39;args&#39; param or the</span>
<span class="sd">    all others depending if its being called from the main function or from another python script.</span>

<span class="sd">    :param args: Basically all the other params but in arguments format.</span>
<span class="sd">    :param config: List of the config file paths to load for the configuration.</span>
<span class="sd">    :param interface: Network card to use for the default config</span>
<span class="sd">    :param no_default_config: If set it applies the default configuration</span>
<span class="sd">    :param allow: If set it sets the policy of all the default chains to ACCEPT.</span>
<span class="sd">    :param drop_all: If set it sets the policy of all the default chains to DROP.</span>
<span class="sd">    :param update_sets: If set it reads the config and updates all the existing kernel ipsets</span>
<span class="sd">    :param update_list: Explicitly indicates which ipsets will be updated.</span>
<span class="sd">    :param exclude_list: Explicitly indicates which ipsets will not be updated.</span>
<span class="sd">    :param deploy: If set it applies the configuration. If not all the rules are being displayed instead of run.</span>
<span class="sd">    :param generate_files: It create the actual rule files for iptables and ip6tables to be used with the restore option</span>
<span class="sd">    :param map_config_files: It creates a dot language code that visually maps the rules</span>
<span class="sd">    :return: 0 if everything goes smoothly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_rules_list</span> <span class="o">=</span><span class="p">[]</span>
    <span class="n">iptables_rules</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">interface</span><span class="p">:</span>
            <span class="n">interface</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">interface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_default_config</span><span class="p">:</span>
            <span class="n">no_default_config</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">no_default_config</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">drop_all</span><span class="p">:</span>
            <span class="n">drop_all</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_all</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">allow</span><span class="p">:</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">update_sets</span><span class="p">:</span>
            <span class="n">update_sets</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">no_default_config</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">update_list</span><span class="p">:</span>
                <span class="n">update_list</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">update_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">update_list</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">exclude_list</span><span class="p">:</span>
                <span class="n">exclude_list</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">exclude_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exclude_list</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">update_sets</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">deploy</span><span class="p">:</span>
            <span class="n">deploy</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deploy</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">generate_files</span><span class="p">:</span>
            <span class="n">no_default_config</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">deploy</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">update_sets</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">generate_files</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generate_files</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">map_config_files</span><span class="p">:</span>
            <span class="n">map_config_files</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">deploy</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">DefaultConfiguration</span><span class="p">(</span><span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/default_conf_files&#39;</span><span class="p">,</span> <span class="n">interface</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">DefaultConfiguration</span><span class="p">(</span><span class="s1">&#39;simulate&#39;</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/default_conf_files&#39;</span><span class="p">,</span> <span class="n">interface</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Error Creating the main objects&quot;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Please check the files are under the provided path/s&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_default_config</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Apply DEFAULT RULES &quot;</span>
        <span class="k">if</span> <span class="n">deploy</span><span class="p">:</span>
            <span class="n">default</span><span class="o">.</span><span class="n">clean_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">))</span>
            <span class="n">default</span><span class="o">.</span><span class="n">clean_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">))</span>
            <span class="n">default</span><span class="o">.</span><span class="n">destroy_all_ipsets</span><span class="p">()</span>
            <span class="n">default</span><span class="o">.</span><span class="n">perform_action</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">clean_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">)))</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">clean_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">)))</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">destroy_all_ipsets</span><span class="p">())</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">perform_action</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">allow</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">deploy</span><span class="p">:</span>
            <span class="n">default</span><span class="o">.</span><span class="n">accept_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">))</span>
            <span class="n">default</span><span class="o">.</span><span class="n">accept_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">))</span>
            <span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">))</span>
            <span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">accept_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">)))</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">accept_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">)))</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">)))</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">drop_all</span> <span class="ow">and</span> <span class="p">(</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">deploy</span><span class="p">:</span>
            <span class="n">default</span><span class="o">.</span><span class="n">final_drop_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">))</span>
            <span class="n">default</span><span class="o">.</span><span class="n">final_drop_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">))</span>
            <span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">))</span>
            <span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">final_drop_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">)))</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">final_drop_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">)))</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">)))</span>
            <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_reader</span> <span class="o">=</span> <span class="n">ReadWriteConfigFiles</span><span class="p">()</span>
            <span class="n">file_parser</span> <span class="o">=</span> <span class="n">file_reader</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="c1"># print file_parser.sections()</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Error reading the files&quot;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Please check the files are under the provided path/s&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deploy</span><span class="p">:</span>
            <span class="n">custom_rules</span> <span class="o">=</span> <span class="n">ManageRules</span><span class="p">(</span><span class="n">file_parser</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">custom_rules</span> <span class="o">=</span> <span class="n">ManageRules</span><span class="p">(</span><span class="n">file_parser</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">generate_files</span><span class="p">)</span>

        <span class="n">custom_rules</span><span class="o">.</span><span class="n">config_integrity_check</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">map_config_files</span><span class="p">:</span>
            <span class="n">visual_rules</span> <span class="o">=</span> <span class="n">RuleVisualMapBuilder</span><span class="p">()</span>
            <span class="n">visual_rules</span><span class="o">.</span><span class="n">rule_map_builder</span><span class="p">(</span><span class="n">file_parser</span><span class="p">,</span> <span class="n">custom_rules</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_sets</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;UPDATE IPsets ONLY&quot;</span>
                <span class="n">custom_rules</span><span class="o">.</span><span class="n">ipsets_update</span><span class="p">(</span><span class="n">update_list</span><span class="p">,</span> <span class="n">exclude_list</span><span class="p">)</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="n">update_sets</span><span class="p">:</span>
                <span class="n">iptables_rules</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">custom_rules</span><span class="o">.</span><span class="n">parse_file</span><span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">generate_files</span><span class="p">:</span>
                    <span class="n">custom_rules</span><span class="o">.</span><span class="n">apply_firewall_rules</span><span class="p">(</span><span class="n">iptables_rules</span><span class="p">)</span>
                    <span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">))</span>
                    <span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">drop_all</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">deploy</span><span class="p">:</span>
                        <span class="n">default</span><span class="o">.</span><span class="n">final_drop_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">))</span>
                        <span class="n">default</span><span class="o">.</span><span class="n">final_drop_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">final_drop_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">)))</span>
                        <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">final_drop_iptables</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">)))</span>
                        <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;iptables_command&#39;</span><span class="p">)))</span>
                        <span class="n">default_rules_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">iptables_save</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="s1">&#39;ip6tables_command&#39;</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">generate_files</span><span class="p">:</span>
                    <span class="n">gen_files</span> <span class="o">=</span> <span class="n">IPTablesFileGenerator</span><span class="p">()</span>
                    <span class="n">gen_files</span><span class="o">.</span><span class="n">write_iptables_files</span><span class="p">(</span><span class="n">default_rules_list</span><span class="p">,</span> <span class="n">iptables_rules</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_default_rules</span><span class="p">(</span><span class="n">default_rules_list</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">generate_files</span><span class="p">:</span>
            <span class="n">gen_files</span> <span class="o">=</span> <span class="n">IPTablesFileGenerator</span><span class="p">()</span>
            <span class="n">gen_files</span><span class="o">.</span><span class="n">write_iptables_files</span><span class="p">(</span><span class="n">default_rules_list</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_default_rules</span><span class="p">(</span><span class="n">default_rules_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span></div>

<span class="c1">############################################################################################################</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../code_documentation/iptables_manager.html#bin.iptables_manager.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function use to expose all the parameters to the command line and call iptables_manager function.</span>

<span class="sd">    :return: void</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type the location of your config file to parse(absolut path)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no_default_config&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply default configuration from scratch&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--allow&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply ACCEPT policy to everything&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--drop_all&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply DROP policy to everything&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--interface&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type the name of nic card you want the default rules to be applied for&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--update_sets&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Update only the ipsets&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--update_list&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Update only the specified ipsets: Use general section names&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--exclude_list&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Exclude these ipsets from update: Use general section names&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--deploy&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Deploy the configuration&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--generate_files&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Generate iptables and ip6tables files&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--map_config_files&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Generates dot language code in order to &#39;</span>
                                                                        <span class="s1">&#39;visualize host file contents&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">exit_code</span> <span class="o">=</span> <span class="n">iptables_manager</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, CERN.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.8</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>